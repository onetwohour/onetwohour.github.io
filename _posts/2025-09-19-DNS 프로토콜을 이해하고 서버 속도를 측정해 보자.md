---
layout: post
title: "DNS 프로토콜을 이해하고 서버 속도를 측정해 보자"
date: 2025-09-19
excerpt: "각 DNS 서버의 속도를 측정해 보고 프로토콜의 차이를 실감해 보자"
tag: 
- DNS
- 메모
comments: true
published: true
---

# [2025-09-19] DNS 프로토콜을 이해하고 서버 속도를 측정해 보자

---

요즘 너무 놀고먹는것 같아서 양심이 좀 찔린다.

그래서 앞으로는 최소 매주 한번 이상 내 지식을 정리하고 공유하려 한다.

겸사겸사 모르는 부분이 있으면 공부하고.

아무튼 오늘 말할 건 DNS 프로토콜이다.

### UDP/TCP

---

사나이의 시대에는 암호화 그런거 없었다. 그냥 남자답게 통으로 DNS 서버에 질의를 날렸다. 보통은 UDP를 주로 사용했고, 예외적인 경우에 TCP를 사용했다. 물론 대 인터넷 시대가 열리면서 낭만의 시대는 가고 보안의 중요성이 강조되기 시작됐다.

암호화를 안하면 발생하는 문제점으로는 DNS 스푸핑이 있다. 쉽게 말하면 다른 사람이 DNS 질의를 낚아채서 가짜 답을 제공하는거다. 그러면 사용자는 가짜 주소에 접속하게 되고, 악성 코드나 해킹의 위험이 발생한다.

> 근데 통신사는 아직도 암호화 DNS를 제공하지 않는다. 하긴 본인들이 직접 사용자들을 해킹하는데 문제 없나?

당연히 이건 심각한 문제였고, 사람들은 암호화된 DNS 질의 방식을 찾게 된다. 그렇게 나온 것이 DoH/DoT다.

### Dns over HTTPS

---

사실 DoH에서 HTTPS는 웹을 위한 프로토콜이다. 헤더-바디로 이뤄진 HTTP를 암호화하기 위해 나온 HTTPS는 TCP를 주로 사용한다. 

왜 굳이 TCP였을까? 그건 TCP가 여러모로 유용했기 때문이다. UDP는 빈 깡통이지만, TCP는 여러가지 기능을 제공했다. 대표적으로 손실된 패킷 복구라든가, 혼잡 제어라든가 하는게 있다. 웹 환경에서는 여러모로 많은 기능이 있는 TCP를 선택하는게 당연했고, 따라서 TCP를 기반으로 HTTP가 만들어진다.

그리고 HTTP에 TLS 기반 암호화를 하나 더한 것이 HTTPS다. HTTPS는 클라이언트-서버 오직 둘만 내용을 볼 수 있다. 여기서 사용되는 것이 비대칭형 암호화 기술이다. 흔히 퍼블릭-프라이빗 키라고 부르는 그거.

서버는 프라이빗 키를 소유하고, 퍼블릭 키를 공유한다. 그리고 클라이언트는 서버가 보낸 퍼블릭 키를 이용해서 암호화한다. 이제 암호화된 파일을 전송하면, 서버는 프라이빗 키를 이용해 암호화를 해제할 수 있다. 퍼블릭 키로 암호화하면 해제할 수 있는건 오직 프라이빗 키이기 때문에 중간에서 가로채도 읽을 수 없다.

당연히 반대도 가능하다. 서버가 프라이빗 키로 암호화하면, 클라이언트는 퍼블릭 키로 해제한다. 그럼 이 파일을 보낸게 서버라는 확신이 생긴다. 왜냐하면 퍼블릭 키로 해제할 수 있는건 오직 프라이빗 키로 암호화한건데, 그건 서버만 들고 있으니까.

이걸 이용해 뭘 할수 있냐면... 대칭 키를 공유할 수 있다. 대칭 키가 뭐냐면, 같은 암호를 공유하는거다. 비대칭 암호화로 대칭키를 공유하고, 공유된 대칭키로 내용물을 암호화한다. 굳이 2가지 방식을 혼용하는 이유는 대칭키가 가볍기 때문이다. 매번 비대칭 암호화하면 복잡하고 계산도 많이 한다. 대칭키는 쉽고 간단하다. 하지만 대칭키를 공유할때 감청당하면 큰일이니 키를 공유할 때만 비대칭 암호화를 하는거다.

이 기술을 그대로 들고와서, DNS에 적용하면 그게 DoH다. 해석하면 이렇다. DNS를 요청한다. 단, HTTP의 형식을 따라서, 그리고 TLS로 암호화하면서.

### Dns over TLS

---

여기서 약간의 의문이 생긴다. 굳이 HTTP 형식으로 보내야 하나? HTTP는 알다시피 웹을 지원하기 위한 프로토콜이다. 근데 굳이? 왜 DNS에서 사용한단 말인가. 그런 사람들을 위해 존재하는게 DoT, Dns over TLS다.

사실 시기상으로는 DoT가 먼저 나왔다. 근데 왜 HTTPS를 먼저 설명했냐 하면, 내맘이다. ㅎㅎ

농담이고, 사실 DoH를 알면 DoT에서는 설명할 게 없기 때문이다. 차이가 있다면 HTTP 사용 유무와 통신 포트의 차이 정도? 그 이외에는 모르겠고, 알아도 큰 차이 없을 듯하다.

아무튼 DoT는 DNS를 TLS로 암호화한거다. DoT는 DoH와 동일하게 TCP로 통신하며, 853 포트를 사용한다. DoH는 웹 표준을 사용하므로 당연히 443 포트를 사용하고.

여기서 갑론을박이 생길 수 있다. 그럼 DoH와 DoT를 사용하는것 중 뭐가 좋을까?

많은 사람들의 얘기를 들어보면 통상 DoH가 은닉성이 보장된다고 말한다. 왜 그러냐 하면, DoH는 웹 표준을 따르기 때문이다.

좀 더 풀어서 설명하면, DoH로 통신하면 이게 보내는게 웹 페이지인지, DNS 요청인지 외부에서는 분간을 할 수 없다. 그러니 검열이 상대적으로 어렵다고 말하는 거고.

반면 DoT는 853이라는 전용 포트를 사용하기 때문에 상대적으로 요청의 유형 분류를 하기 쉬워진다. 적어도 853 포트로 보내는건 DNS 하나뿐이니까, 853포트로 요청하는건 죄다 DNS라고 봐도 무방하니.

하지만 서버 입장에서는 DoT가 관리하기 쉽다고 한다. 전용 포트가 있으니 따로 분류할 필요 없고, 그럼 관리하기 편하니 그렇다고 한다. 정말로 그런지는 잘 모르겠다.

아무튼 이런저런 이유로 DoH가 은닉성이 좋다고 한다. 다만, HTTP 형식이기 때문에 불필요한 데이터가 전송될 가능성이 있다. 물론 현대 시대 인터넷에서는 극히 미미한 영향이지만.

### DNS over QUIC

---

하지만 DoH와 DoT 둘 다 태생적으로 가지는 약점이 있다. 암호화 문제는 아니다. 지금도 현역인 방식이니까. 문제는 둘 다 TCP를 사용한다는 거다.

TCP, 좋은 프로토콜이다. 다만 너무 느리다. TCP는 기본적으로 연결을 시작하려면 3번의 대화를 해야한다. 

1. A: 준비됐어?
2. B: 물론이지.
3. A: 나도 ㅎㅎ

대충 이런식이다. 디테일은 좀 다르긴 한데 대강은 맞다.

문제는 이렇게 연결을 시작하기 위해 매번 3번의 과정이 필요하다는 거다.당연히 느리고, 또 TCP는 기본적으로 IP와 친하기 때문에 IP 기반 연결이 된다.

IP연결 기반이 예전에는 문제가 되지 않았다. 다들 고정된 컴퓨터에서 통신했으니 어지간하면 IP가 변경되지 않았으니. 문제는 바쁘다 바빠 현대사회가 되면서 모바일 통신이 폭발적으로 늘었다는 거다.

모바일 환경에서는 사람들은 움직이면서 통신을 한다. 즉, IP가 변경된다. IP가 변경되면 TCP는 이전 연결을 기억하지 못하고 새로운 연결을 해야한다. 연결을 수시로 해야하니 당연히 느리다. 심지어 TCP는 혼잡 제어를 위해 기본적으로 느리게 통신을 시작한다(Slow-Start).

그리고 TCP는 HEAD-OF-LINE 문제가 있다. 기본적으로 TCP는 스트림 단위로 전송하게 되는데 앞에서 하나가 뻑나면 나머지는 대기해야 한다. 심각하게 느리다.

이걸 해결하려고 수많은 사람들이 고민했고, 그 결과 나온게 QUIC이다. QUIC은 UDP 기반이다. 

?? UDP 버려진거 아니었어? 

라고 할 수 있지만, UDP는 TCP에게 없는 장점이 있다. 기능이 뭣도 없으니 빠르긴 빠르다는 거다.

그래서 사람들은 UDP를 관짝에서 부활시켰고, 이걸 기반으로 QUIC을 만든다. QUIC은 모바일 환경을 저격으로 제시된 프로토콜이다. 물론 모바일 말고 PC 환경도 쓰는게 좋다. 

QUIC은 일단 0-RTT, 1-RTT가 가능하다. RTT란 아까 말한 연결하기 위해 필요한 대화를 말한다.

즉 QUIC은 다음과 같다.

1. A: 준비됐어? 됐으면 이것좀 ㅎㅎ
2. B: ㅇㅇ 보냈다.

이건 처음 연결 시 그런거고, QUIC은 기본적으로 이전 연결을 기억한다. 그러므로 다음에 다시 연결하면

1. A: 해 줘
2. B: ㅇㅇ 여기

이렇게 준비됐는지도 묻지 않는다. 당연히 빠를 수밖에.

또 HEAD-OF-LINE 문제도 없다. 스트림 내부적으로 병렬로 전송하기 때문에 하나가 뻑난다고 멈추는 문제는 없다. 정말 좋은 프로토콜이다.

물론 QUIC이 무적은 아니다. 기본적으로 표준 API가 없어서 알아서 잘 상용 소프트웨어를 가져와서 사용해야 하고 미묘하게 컴퓨팅 파워가 더 들긴 한다. 근데 요즘 컴퓨터 성능 보면 크게 문제 없는 거 같기도 하고.

아무튼 이걸 가지고 나온게 Dns over QUIC이다. DoT와 동일하게 853 포트(UDP)를 사용한다. 사실상 DoT에서 TCP를 QUIC으로 바꾼 것 말고는 없다.

그럼 암호화는 어디서 하냐고 하는데, QUIC은 TLS 암호화가 기본 내장이다. 그래서 딱히 암호화를 위해 추가되는 과정은 없고, 그냥 QUIC 프로토콜을 사용하면 무조건 암호화를 해야한다.

또 QUIC은 IP로 상대를 식별하지 않는다. 각 연결마다 ID를 부여하고, ID를 이용해 연결을 유지한다. 그러므로 상대의 IP가 바뀌더라도 연결을 새로 할 필요는 없다. 그야말로 모바일-최적화된 프로토콜이다.

### DNS over HTTP/3

---

그럼 여기서 아까 DoH/DoT 관계를 생각해 봐야한다. 둘은 거의 동일하지만 HTTP/포트 번호 차이만 있다고 했다. 당연히 QUIC도 이런 관계가 있어야 하지 않겠는가.

당연히 있다. HTTP/3이다. 이건 HTTP를 QUIC으로 전송하는 거다. 아까 HTTP는 TCP를 기반으로 전송된다 했는데, TCP 대신 QUIC을 사용하면 HTTP/3이다. 대신 서버/클라이언트가 둘다 지원해야 하지만.

그래서 보통 통신할 때 해더를 붙여서 지원 여부를 알려준다. 보통은 Alt-Svc 헤더가 있으면 HTTP/3을 지원하는거고 아니면 없는거다.

DoH/3은 크게 설명할 게 없다. HTTP 형식으로 443 형식으로 보내는 것. 아까 DoH/DoT와 완전히 동일하다. 딱히 할말 없다.

### DNS 서버 속도 측정

---

그래서 최종장이다. 이걸 하고 싶어서 지금까지 장황하게 설명했다.

나는 DNS 서버의 응답 속도가 얼마나 차이나는지 알고 싶었다. 그래서 여러 서버를 대상으로 측정을 시도했다.

측정 방식은 우분투 환경에서 kdig를 이용해 측정했다. 총 100번의 쿼리를 날려서 걸린 시간을 측정했으며, 각 쿼리는 캐시되지 않도록 무작위 문자열을 생성해서 조회하도록 수행했다.

먼저 DoH로 시도했다. 

시도한 서버는 다음과 같다.

Cloudflare, Google, AdGuard, Quad9, DNS.SB, NextDNS

| 제공업체 (Provider) | 서버 IP (Server IP) | 평균 (ms) | 최소 (ms) | 최대 (ms) | 표준편차 (ms) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **AdGuard** | 94.140.14.14 | 169.33 | 106.4 | 261.8 | 50.6358 |
| **AdGuard** | 94.140.15.15 | 180.22 | 105.7 | 1253.4 | 118.7072 |
| **Cloudflare** | 1.1.1.1 | 34.92 | 16.2 | 1214.2 | 123.7194 |
| **Cloudflare** | 1.0.0.1 | 39.62 | 16.0 | 1071.4 | 111.3110 |
| **Quad9** | 9.9.9.9 | 142.83 | 112.8 | 1134.3 | 104.3900 |
| **Quad9** | 149.112.112.112 | 151.87 | 113.3 | 1199.2 | 113.0653 |
| **DNS.SB** | 185.222.222.222 | 143.79 | 125.7 | 390.1 | 47.7554 |
| **DNS.SB** | 45.11.45.11 | 138.85 | 124.4 | 380.9 | 35.3682 |
| **Google** | 8.8.8.8 | 243.47 | 154.7 | 325.9 | 39.2185 |
| **Google** | 8.8.4.4 | 245.28 | 152.8 | 376.5 | 41.6167 |
| **NextDNS** | 103.127.124.46 | 43.70 | 16.7 | 111.9 | 18.6030 |
| **NextDNS** | 141.164.63.208 | 86.09 | 16.9 | 156.6 | 54.8139 |

당연하지만, 한국에 있는 서버가 빠르다. 특히 Cloudflare가 상당히 좋은 속도를 보였다. 단, 표준편차가 높아서 가끔씩 튀기는 하지만.

NextDNS도 나쁘지 않다. 서버 하나가 느리긴 한데, 좋은 속도다.

나머지는... 뭐 특수한 목적이 있으면 쓸만한 수준이랄까. 근데 실사용하려면 큰결심이 필요할 것 같다.

DoT는 큰 차이 없을 테니 넘어가고, QUIC을 사용해 보자.

문제가 있다면 QUIC을 지원하는 서버가 2군데 뿐이라는건데... Cloudflare와 Google은 HTTP/3을 지원하지만 문제는 kdig는 HTTP/3을 지원하지 않는다. 그래서 QUIC을 지원하는 서버만 측정을 진행했다.

| 제공업체 (Provider) | 서버 IP (Server IP) | 평균 (ms) | 최소 (ms) | 최대 (ms) | 표준편차 (ms) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **AdGuard** | 94.140.14.14 | 85.22 | 71.4 | 154.9 | 25.1843 |
| **AdGuard** | 94.140.15.15 | 82.90 | 71.0 | 157.9 | 24.1769 |
| **NextDNS** | 103.127.124.46 | 16.14 | 13.2 | 39.2 | 3.3009 |
| **NextDNS** | 141.164.63.208 | 66.90 | 14.0 | 145.8 | 48.8768 |

놀라운 수준으로 속도가 줄어들었다. 보면 평균적으로 대략 절반 가까이 속도가 줄었다. 이게 최신기술이고 이게 테크놀로지다.

클라우드플레어도 HTTP/3을 지원하니 아마 측정하면 훨씬 좋은 속도를 보일 것이다. 측정을 못하는게 아쉽다.

물론 실사용에서 체감하는 속도가 다를 수 있다. 그런 경우는 보통 물리적으로 서버가 가까운 곳에 살거나 anycast를 개떡같이 잡아줘서 그런것일 가능성이 크다. 프로토콜을 잘못 설정했거나 캐시된 걸 보고 착각했을 수도 있고.

물론 암호화 안한 UDP로 쿼리 날리면 한국 서버는 최대 5~6ms 수준으로 속도가 빨라진다. 하지만 암호화 안할거면 이 글에 관심 없을거고, 관심있는 사람은 암호화가 얼마나 중요한 지 알 테니 UDP는 패스한다.

### 번외: DNSCrypt

---

사실 이거 말고도 다른 프로토콜이 있다. DNSCrypt라고, 이것도 UDP 기반 프로토콜이긴 한데 표준으로 채택된 건 아니다. 나온건 DoT보다 먼저긴 한데 아는 사람이 잘 없다. 일반 사람들은 거의 쓸 일이 없고, 특징이 있다면 상당히 경량화되어있어서 좋은 속도가 나온다는 것이다. 이건 TLS 기반 암호화는 아니고 타원 곡선 암호 어쩌구 하던데...

솔직히 잘 모르는 프로토콜이다. 쓸일도 거의 없고. 하지만 꾸준히 수요가 있는 아는 사람만 아는 맛집같은 느낌이다. 

표준이 아니어서 전용 소프트웨어를 설치해야 사용할 수 있긴 하지만.

### 결론

---

| 프로토콜 | 전송/HTTP 버전 | 기본 포트 | 장점 | 단점 |
| :--- | :--- | :--- | :--- | :--- |
| DoT | TCP + TLS | 853/TCP | 단순함, 적은 오버헤드 | 전용 포트로 인한 식별/차단 용이 |
| DoH | HTTP/1.1 또는 HTTP/2 (TCP + TLS) | 443/TCP | 웹 트래픽과 섞여 은닉성 우수 | HTTP 헤더로 인한 약간의 오버헤드 |
| DoQ | UDP 기반 QUIC(TLS 1.3 내장) | 853/UDP | 빠른 속도 + 모바일에 최적화 | DoT/DoH에 비해 아직 지원 서버 적음 |
| DoH3 | HTTP/3(QUIC 위의 HTTP) | 443/UDP | DoH의 은닉성 + DoQ의 속도 | 최신 기술이라 지원 서버/클라이언트 제한적 |

기본적으로 가까운 서버가 제일 좋고, QUIC/HTTP3을 지원하면 더욱 좋다.

---

지금까지 DNS 프로토콜에 관해 정리했고, 정리하면서 헷갈리는 부분을 다시 되짚으니 좋은 것 같다. 최소 일주일에 한번은 올려보겠다. 언제까지 할 수 있을지는 모르겠지만.

